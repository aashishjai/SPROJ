## Documentation for DNS-Traceroute Data Collection Pipeline

The code works by sending a *DNS_BUNDLE* to all the vantage points to run the data collection on those vantage points and send the data back to the Host machine running the experiment. 

## Prerequisites and assumptions

- The code assumes that you have root access to the machine, since at many places we use a custom resolver to resolve domains, which requires root access
- Python version > 3.7 for the data collection
- The set-up scripts (the zip file in the previous directory) to be installed in each of the vantage points. These scripts set up a local resolver on the remote machine and install all the required packages

## Data Collection

An easy to start the data collection over a set of 100,000 domains is to simply run `python run_all.py run_DNS` in the previous folder, however, this will require the host machine to remain on continuously for ~18 hours. This script waits for each step to complete by waiting a set amount of time. This time is an overestimation to make sure the previous step has completed before automatically running the next step. 

For each step, in order to check if the step has completed, a summary file can be generated and sent back to the host machine. The summary file can be generated by the command

```
$ python do_all_EC2_and_one_provider_VPS.py 9
```

The steps are as follows

#### Step 1

**Commands to run: **

- `python run_DNS_pipeline.py 0`: Carries out system-wide configurations for the default DNS resolver

- `python run_DNS_pipeline.py 1`: Any previous data in the same folder is deleted. The DNS Bundle is transferred to each VP
- `pythun run_DNS_pipeline.py 2`: The custom resolver starts to resolve the input set of domains and creates the *resolved_domains.txt* and *blocked_domains.txt* text files.

**How to check if step has completed**: Generate the summary file and look at the columns labeled "Resolved domains" and "Unresolved Domains". Both these numbers should sum up to the number of the input domains

#### Step 2

**Commands to run:** 

- ``python run_DNS_pipeline.py 3`: The resolved domains are transferred back to the host machine. A union is taken of these domains and is sent back to each VP
- `python run_DNS_pipeline.py 4`:  The test DNS traceroute is run on each VP, these will be used to find the last responding router.

**How to check if step has completed: ** Generate the summary file after every ~3 hours and look at the columns labelled "*Blocked domains*" and "*DNS traceroutes done*". Ideally, the numbers in the "*DNS traceroutes done*" column should be 1 higher than the numbers in the corresponding "*Blocked domains*" column. However, in case we run into errors for a traceroute on a domain, it may be a little less than that. Regardless of the case, for an input set of 100k domains, this step does not take more than 8 hours.

#### Step 3

**Commands to run:** 

- `python run_DNS_pipeline.py 5`:  The *server_side_blocked* domains are transferred back to the host machine and a union is taken of these candidates

- `python run_DNS_pipeline.py 6`: The *server_side_blocked* are all sent back to each VP and DNS-Traceroutes are run on all of these domains. This step ensures that for a candidate domain, we have the last-responding IP from the VP in which it was blocked, and hopefully a complete traceroute from a VP where it was not blocked, which we can then compare to see where the blocking took place

**How to check if step has completed:** Generate the summary file after every ~3 hours. Find the size of the "*server_side_blocked*" domains by running the following command (assuming the config variables have not been changed)

```
cat ./server_side_blocked_of_each_VP/have_auth_no_ip_extended.common_three_runs.txt | wc -l 
```

Now compare the number in the "MDA DNS done" column with the number of server side blocked domains (which you get by running the command above). If they are the same, that means all the traceroutes are complete and step 3 is finished

#### Step 4

**Command to run**: 

- `python run_DNS_pipeline.py 7`: This transfers the data collected from all the VPs back to the host machine



